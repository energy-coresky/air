#!/usr/bin/env php
<?php

if (1 == $argc)
    $argv = [0, 'commands', "Usage: sky command [param ...]\nCommands are:\n", [
        's' => 'Run PHP web-server',
        'd' => 'List dirs (from current dir)',
        'php' => 'Lint PHP files (from current dir)',
    ]];

$d = 'd' == $argv[1];
if ($d || 'php' == $argv[1]) {
    require __DIR__ . '/w2/rare.php'; # add dir to the PATH where sky.bat placed
    $dirs = Rare::walk_dirs('.');
    if ($d) {
        print_r($dirs);
    } else foreach($dirs as $one) {
        $files = Rare::list_path($one, 'is_file');
        foreach($files as $one)
            system("php -l $one");
    }

} elseif ('s' == $argv[1]) {
    system('explorer "http://localhost:' . ($argv[2] ?? 8888) . '"');
    system("php -S localhost:" . ($argv[2] ?? 8888) . ' index.php');

} else {
    define('DIR_R', getcwd());
    $test = function ($cd, $m) {
        if (!is_file($fn = "$cd/$m/conf.php"))
            return false;
        return strpos(file_get_contents($fn), 'DIR_M');
    };
    $m = basename(__DIR__);
    do {
        if ($test($cd = getcwd(), $m) || $test($cd, $m = 'main'))
            break;
        $m = basename($cd);
        chdir('..');
        if ($cd == getcwd())
            exit("SKY application not found\n");
    } while(true);

    define('DIR', $cd);
    require "$m/conf.php";
    $sky = new SKY;
    new Console($argv);
}

echo "\n";
